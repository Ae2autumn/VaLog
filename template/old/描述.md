VaLog 博客系统 - 修正版技术需求规格

一、核心功能概述

基于 GitHub Issues 的静态博客生成系统，自动生成响应式博客网站，部署到 GitHub Pages。搜索功能已内嵌在客户端实现。

二、数据源与内容抓取

2.1 数据来源

· 来源：GitHub Issues（每个 Issue 对应一篇博客文章）
· 抓取字段：
  · 文章标题（Issue 标题）
  · 发布日期（Issue 创建时间）
  · 文章标签（Issue Labels）
  · 文章内容（Issue Body）
  · Issue 编号（用于生成唯一文件名）

2.2 摘要生成（变更）

· 提取规则：提取 Issue Body 中第一个 !vml- 语法中的 <span> 标签内容，不限长度
· 处理逻辑：
  1. 扫描 Issue Body，查找第一个 !vml- 开头的行
  2. 如果找到，提取该行中 <span> 标签内的文本内容
  3. 如果没有找到 !vml- 或 <span> 标签，则摘要为空（不显示）
· 示例：
  ```markdown
  !vml-<span>这是一段摘要内容，可以包含任意长度的文字，用于在卡片中显示</span>
  这里是文章的正文内容...
  ```

三、配置文件系统

3.1 配置文件

· config.yml：用户配置文件（根目录）
· base.yaml：生成器内部数据文件（自动生成）

3.2 config.yml 配置项

```yaml
# 基础博客配置
blog:
  avatar: "static/avatar.png"           # 头像文件路径（相对路径）
  name: "VaLog"                         # 博客名称
  description: "个人技术博客"            # 博客描述
  favicon: "static/favicon.ico"         # 网站图标

# 浮动菜单配置
floating_menu:
  - tag: "about"                        # 需要匹配的文章标签
    display: "关于"                      # 菜单显示文本
  - tag: "contact"                      # 需要匹配的文章标签(抓取Issues)
    display: "联系"                      # 菜单显示文本
  # 用户可自定义添加，但总项目数不超过10个

# Special卡片配置
special:
  top: false                            # true: 置顶文章放入Special | false: 普通列表显示置顶
  view:                                 # 当Special无内容时显示的文本信息
    RF_Information: "备案信息文本"
    RF_Link: "https://beian.miit.gov.cn"
    Copyright: "© 2023 VaLog 版权所有"
    C_Link: "https://github.com"
    Total_time: "2023.01.01"            # 格式: yyyy.mm.dd，自动计算运行天数
    Others: "其他说明文本"

# 主题配置（**修正**）
theme:
  mode: "dark"                          # 主题模式: "dark" | "light"，默认"dark"
  primary_color: "#e74c3c"              # 主题主色
  dark_bg: "#121212"                    # 暗色背景（修正为代码中的实际值）
  light_bg: "#f5f7fa"                   # 亮色背景
```

3.3 base.yaml 结构（自动生成）

```yaml
# 基础信息（从config.yml获取）
blog:
  avatar: "Url"                         # 头像URL（生成时替换为完整路径）
  name: "VaLog"
  description: "个人技术博客"
  favicon: "Url"                        # favicon URL

# 文章数据
articles:
  - id: "article-1"
    title: "文章标题"
    tags: ["技术", "教程"]
    verticalTitle: "简写标题"            # 标签的第一个或自定义
    date: "2023-10-01"
    content:
      - "段落1内容"
      - "段落2内容"
    url: "/article/1.html"
    gradient: ["#e74c3c", "#c0392b"]    # 渐变颜色，默认值

# Special卡片数据
specials:
  - id: "special-1"
    title: "特殊卡片标题"
    tags: ["项目", "展示"]
    content:
      - "卡片内容..."
    url: "https://example.com"
    gradient: ["#e74c3c", "#c0392b"]
  # 仅文本模式触发条件：只有content字段，无title和tags,或者有字段但无数据
  - id: "special-text-only"
    content:
      - "这里显示配置中的view文本"
    # 无title和tags字段时会触发仅文本模式

# 浮动菜单数据
menu_items:
  - tag: "about"
    display: "关于"
    url: "/article/about.html"          # 如果存在对应标签文章则有URL
  - tag: "contact"
    display: "联系"
    url: null                           # 如果不存在对应标签文章则为null
```

四、Special卡片系统

4.1 显示规则

· 始终显示：Special卡片区域在页面中始终存在
· 内容状态：
  1. 正常模式：有title、tags、content等完整数据
  2. 仅文本模式：只有content字段，无title和tags（触发条件）
  3. 无内容：无任何Special卡片数据，卡片默认关闭且不可打开

4.2 置顶与Special逻辑

· GitHub置顶：手动置顶的文章（最多3个）
· 标签置顶：带有 top 标签的文章
· Special文章：带有 special 标签的文章

4.3 配置规则

· special.top: true：所有置顶文章放入Special卡片，使用"top"标签不限制置顶数量
· special.top: false：最多1个GitHub置顶文章，显示在普通列表顶部，不可使用top标签也不允许超过一个置顶
· (为false但存在有"special"标签的文章时,带有"special"标签的文章显示在special卡片中,不受影响)

4.4 仅文本模式触发条件（新增）

当Special卡片数据满足以下条件时，触发仅文本模式：

```yaml
specials:
  - id: "special-text"
    content:                            # 只有content字段
      - "这里显示自定义文本内容"
    # 无title字段
    # 无tags字段
    # 无url字段（可选）
    
    或者
    
specials:
  - id: "special-text"
    title : ""                          #有字段但无内容
    tags : ""
    verticalTitle: ""
    date: ""
    content:                            # 只有content字段
      - "这里显示自定义文本内容"
```

五、HTML模板系统（重大变更）

5.1 模板文件

```
template/
├── home.html                    # 主页模板（使用直接替换占位符方式）
└── article.html                 # 文章页模板（使用Jinja2模板引擎）
```

5.2 模板处理流程（变更）

5.2.1 主页生成

1. 读取 template/home.html 模板文件
2. 直接替换占位符（不使用Jinja2）：
   · 使用字符串替换方式替换硬编码的占位符
   · 将blogData、menuItems等数据以JSON格式注入到JavaScript中
3. 生成 docs/index.html

5.2.2 文章页生成

1. 读取 template/article.html 模板文件
2. 使用Jinja2模板引擎：
   · 渲染文章内容（Markdown转HTML）
   · 填充文章标题、标签、日期等数据
3. 生成 docs/article/{id}.html

5.3 主页模板占位符（新增）

home.html中的占位符需要被替换：

```html
<!-- 需要替换的占位符 -->
<title>VaLog</title> <!-- 替换为博客名称 -->
<link rel="icon" href="favicon.ico"> <!-- 替换为favicon路径 -->
<img src="Url" alt="avatar"> <!-- 替换为头像URL -->
<div class="mobile-title">VaLog</div> <!-- 替换为博客名称 -->
<p>Introduction</p> <!-- 替换为博客简介 -->

<!-- JavaScript数据注入点 -->
<script>
// ==================== 数据与状态管理 ====================
const blogData = {
  articles: [],
  specials: []
};

const menuItems = [];
</script>
```

5.4 文章页模板变量（Jinja2）

article.html中的Jinja2变量：

```html
<!-- 文章页模板变量 -->
<title>{{ article.title }} - {{ blog.name }}</title>
<link rel="icon" href="{{ blog.favicon }}">

<div class="header">
  <h1 class="title">{{ article.title }}</h1>
  <p class="summary">{{ article.summary }}</p> <!-- 摘要 -->
  <div class="date">{{ article.date }}</div>
  <div class="tags">
    {% for tag in article.tags %}
    <span class="tag">{{ tag }}</span>
    {% endfor %}
  </div>
</div>

<div class="content">
  {{ article.content|safe }} <!-- Markdown转换后的HTML内容 -->
</div>
```

六、文章处理与生成

6.1 特殊语法处理

```python
def process_html_inline(content):
    """处理!vml-开头的HTML内联语法"""
    import re
    pattern = r'!vml-(.+?)(?=\n|$)'
    def replace_html(match):
        return match.group(1)  # 直接输出HTML，不转义
    return re.sub(pattern, replace_html, content)

def extract_summary(content):
    """提取摘要（新逻辑）"""
    import re
    # 查找第一个!vml-开头的行
    vml_pattern = r'!vml-(.+)'
    match = re.search(vml_pattern, content)
    if not match:
        return ""  # 没有找到，摘要为空
    
    vml_line = match.group(1)
    # 提取<span>标签内容
    span_pattern = r'<span[^>]*>(.*?)</span>'
    span_match = re.search(span_pattern, vml_line)
    if span_match:
        return span_match.group(1).strip()
    return ""
```

6.2 内容处理流程

1. 从Issue Body获取Markdown
2. 提取摘要（新逻辑）
3. 处理HTML内联语法（!vml-开头的行）
4. 去除!vml-摘要行（如果有）
5. Markdown转HTML
6. 保存到O-MD目录

七、生成引擎实现（单文件）

八、目录结构

```
.github/workflows/
└── VaLog.yml                   # GitHub Actions工作流

config.yml                     # 用户配置文件
base.yaml                      # 内部数据文件（自动生成）
VaLog.py                       # 主生成脚本（单文件）
requirements.txt               # Python依赖（包括Jinja2）

template/                      # HTML模板
├── home.html                  # 主页模板（包含占位符）
└── article.html               # 文章页模板（Jinja2格式）

docs/                          # 生成目录（GitHub Pages）
├── index.html                 # 主页（生成）
├── article/                   # 文章目录
│   ├── 1.html                 # 文章页（生成）
│   ├── 2.html
│   └── ...
└── favicon.ico

O-MD/                          # 原始Markdown缓存
├── 1.md
├── 2.md
└── articles.json              # 文章状态记录

static/                        # 静态资源
├── avatar.png                # 头像
├── favicon.ico               # 图标
└── custom/                   # 用户自定义
    ├── custom.css
    └── custom.js

README.md                      # 项目说明
LICENSE                        # 许可证
.gitignore                     # Git忽略
```

九、GitHub Actions工作流（更新）

十、文章链接系统

10.1 链接生成规则

· 主页文章卡片：点击跳转到对应文章页
· 浮动菜单项：如果有对应标签文章，链接到该文章页
· Special卡片：如果有URL，链接到对应地址

10.2 文件路径

· 主页：/index.html
· 文章页：/article/{issue_number}.html
· 静态资源：/static/ 目录下

十一、搜索功能（保持不变）

11.1 客户端搜索

· 已内嵌实现：搜索功能完整实现在 template/home.html 中
· 无需额外配置：使用 blogData 中的数据动态搜索
· 搜索模式：
  · 标题搜索
  · 标签搜索
  · 内容搜索

十二、生成流程（更新）

12.1 完整流程

```python
# VaLog.py中的主流程
def main():
    # 1. 读取config.yml
    config = read_config("config.yml")
    
    # 2. 获取GitHub Issues
    issues = fetch_issues_from_github()
    
    # 3. 处理文章数据（包括新摘要逻辑）
    articles_data = process_articles(issues, config)
    
    # 4. 生成base.yaml
    generate_base_yaml(config, articles_data)
    
    # 5. 生成主页（使用占位符替换）
    generate_home_page("template/home.html", "docs/index.html")
    
    # 6. 生成文章页（使用Jinja2）
    for article in articles_data['articles']:
        generate_article_page(article, "template/article.html", f"docs/article/{article['id']}.html")
```

十三、错误处理

13.1 配置验证（更新）

```python
def validate_config(config):
    """验证配置文件"""
    errors = []
    
    # 浮动菜单数量验证
    floating_menu = config.get('floating_menu', [])
    if len(floating_menu) > 10:
        errors.append("浮动菜单不能超过10个")
    
    # 主题模式验证
    theme_mode = config.get('theme', {}).get('mode', 'dark')
    if theme_mode not in ['dark', 'light']:
        errors.append("theme.mode 必须是 'dark' 或 'light'")
    
    # 颜色格式验证
    import re
    color_pattern = re.compile(r'^#[0-9a-fA-F]{6}$')
    
    primary_color = config.get('theme', {}).get('primary_color', '#e74c3c')
    if not color_pattern.match(primary_color):
        errors.append(f"primary_color 格式错误: {primary_color}")
    
    return errors
```

13.2 GitHub API错误处理（保持不变）

十四、部署与使用

14.1 首次部署

1. 创建GitHub仓库
2. 添加config.yml配置文件
3. 添加template目录和模板文件
4. 添加VaLog.yml工作流
5. 启用GitHub Pages（gh-pages分支）
6. 创建GitHub Issues作为文章

14.2 日常使用

1. 在GitHub Issues中创建/编辑文章
2. 系统自动触发重新生成
3. 网站自动更新

14.3 自定义扩展

· 自定义样式：修改 static/custom.css
· 自定义脚本：修改 static/custom.js
· 自定义模板：修改 template/ 中的文件

十五、注意事项（更新）

1. 双模板引擎策略：主页使用占位符替换，文章页使用Jinja2
2. 摘要提取新逻辑：提取第一个!vml-中的<span>标签内容
3. 仅文本模式触发：Special卡片只有content字段时触发
4. 主题模式修正：只有dark和light两种模式
5. 路径处理：所有文章链接路径基于docs目录作为根目录
6. 数据注入：主页数据通过字符串替换方式注入JavaScript