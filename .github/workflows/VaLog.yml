name: VaLog Blog CI/CD

on:
  # å½“ Issues æœ‰å˜åŒ–æ—¶
  issues:
    types: [opened, edited, reopened]
  # å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶
  push:
    branches: [ main ]
  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º
  schedule:
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Generate VaLog Blog
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ Pythonç‰ˆæœ¬: $(python --version)"
        echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
        echo "ğŸ“Š ä»“åº“: ${{ github.repository }}"
        
        # å®‰è£…ä¾èµ–
        pip install PyYAML markdown requests Jinja2 Pillow
        
        # æŸ¥çœ‹é…ç½®æ–‡ä»¶
        if [ -f "config.yml" ]; then
          echo "âœ… æ‰¾åˆ° config.yml"
          head -20 config.yml
        else
          echo "âŒ æœªæ‰¾åˆ° config.yml"
          exit 1
        fi
        
        # ç”Ÿæˆåšå®¢
        echo "ğŸš€ å¼€å§‹ç”Ÿæˆåšå®¢..."
        python VaLog.py --deploy generate
        
        # æ£€æŸ¥ç”Ÿæˆç»“æœ
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
        find docs -type f 2>/dev/null || echo "æœªæ‰¾åˆ° docs ç›®å½•"
        
    - name: Upload generated site
      uses: actions/upload-artifact@v3
      with:
        name: vlog-blog
        path: docs/
        retention-days: 1

  deploy-pages:
    needs: generate-blog
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download generated site
      uses: actions/download-artifact@v3
      with:
        name: vlog-blog
        path: docs
        
    - name: Show deployment files
      run: |
        echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²çš„æ–‡ä»¶:"
        find docs -type f | sort
        echo ""
        echo "ğŸ“Š æ–‡ä»¶æ€»æ•°: $(find docs -type f | wc -l)"
        
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Upload to Pages
      uses: actions/upload-pages-artifact@v1
      with:
        path: docs/
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
      
    - name: Show blog URL
      run: |
        echo "ğŸ‰ åšå®¢éƒ¨ç½²å®Œæˆ!"
        echo "ğŸŒ è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "ğŸ“Š GitHub Pages è®¾ç½®: https://github.com/${{ github.repository }}/settings/pages"